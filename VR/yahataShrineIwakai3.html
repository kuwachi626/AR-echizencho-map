<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>YahataShrine VR</title>
    <meta name="description" content="360° Image - A-Frame">
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
</head>
<body>
    <a-scene>
        <!-- 360度画像の背景 -->
        <a-sky id="image360" src="../img_360/YahataShrine(iwakai)3_360.jpg" rotation="0 -90 0"></a-sky>

        <!-- カメラとカーソルの設定 -->
        <a-entity camera look-controls>
            <!-- カーソル設定 -->
            <a-entity cursor="fuse: true;" 
                      position="0 0 -1"
                      geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                      material="color: blue; shader: flat">
            </a-entity>
        </a-entity>

        <a-text
            value="マップへ"
            font="../noto-sans-cjk-jp-msdf.json"
            font-image="../noto-sans-cjk-jp-msdf.png"
            negate="false"
            scale="1 1 1"
            position="-0.5 2.6 -1.5"
            color="#000">
        </a-text>

        <a-text
            value="戻る"
            font="../noto-sans-cjk-jp-msdf.json"
            font-image="../noto-sans-cjk-jp-msdf.png"
            negate="false"
            scale="1 1 1"
            position="0.2 2.6 1.5"
            rotation="0 180 0"
            color="#000">
        </a-text>

        <!-- 球体を使ったリンク -->
        <a-sphere   id="linkSphere"
                    position="0 1.6 -1.5"
                    radius="0.6" color="#FFF"
                    material="opacity: 0.6;">
        </a-sphere>

        <a-sphere   id="linkSphere2" src="../rf/YahataShrine(iwakai)2_rf.jpg"
                    position="0 1.6 1.5"
                    radius="0.6" color="#FFF"
                    material="opacity: 0.6;">
        </a-sphere>

        <!-- スクリプト -->
        <script>
            
            const imagePaths = [
                "../img_360/YahataShrine(iwakai)3_360.jpg",
                "../rf/YahataShrine(iwakai)2_rf.jpg"
            ];

            // IndexedDBの初期化
            function initDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open("image360DB", 1);
                    request.onerror = () => reject("Database failed to open");
                    request.onsuccess = () => resolve(request.result);
                    request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains("images")) {
                        db.createObjectStore("images", { keyPath: "id" });
                    }
                    };
                });
            }

            // 画像がIndexedDBに存在するか確認
            async function isImageInDB(id) {
                const db = await initDB();
                return new Promise((resolve) => {
                    const transaction = db.transaction(["images"], "readonly");
                    const store = transaction.objectStore("images");
                    const request = store.get(id);

                    request.onsuccess = () => {
                    resolve(!!request.result); // データが存在すればtrue、なければfalseを返す
                    };
                    request.onerror = () => {
                    resolve(false);
                    };
                });
            }

            // 画像をURLからBase64に変換して保存
            async function saveImageToDB(url, id) {
                const db = await initDB();

                fetch(url)
                    .then(response => response.blob())
                    .then(blob => {
                        const reader = new FileReader();
                        reader.onload = () => {
                            const base64Data = reader.result;
                            const transaction = db.transaction(["images"], "readwrite");
                            const store = transaction.objectStore("images");

                            const imageRecord = {
                            id: id,
                            data: base64Data
                            };
                            store.put(imageRecord);

                            transaction.oncomplete = () => {
                            console.log(`Image ${id} saved to IndexedDB`);
                            };
                            transaction.onerror = () => {
                            console.error(`Error saving image ${id} to IndexedDB`);
                            };
                        };
                        reader.readAsDataURL(blob);
                    })
                    .catch(err => {
                        console.error(`Error fetching image ${url}: ${err}`);
                });
            }

            // IndexedDBから特定の画像を取得してsrcに設定
            async function loadImageToAImage(id, elementId) {
                const db = await initDB();
                const transaction = db.transaction(["images"], "readonly");
                const store = transaction.objectStore("images");

                // 指定されたIDの画像を取得
                const request = store.get(id);

                request.onsuccess = function() {
                    const record = request.result;
                    if (record) {
                    const imageSrc = record.data;
                    // A-Frameのa-imageエンティティのsrcを設定
                    document.querySelector(`#${elementId}`).setAttribute("src", imageSrc);
                    console.log(`Image ${id} loaded and set to #${elementId}`);
                    } else {
                    console.log(`No image found in IndexedDB with id: ${id}`);
                    }
                };

                request.onerror = function() {
                    console.error(`Failed to load image with id ${id} from IndexedDB`);
                };
            }

            window.onload = async function() {
                for (const path of imagePaths) {
                    const imageId = path.split('/').pop(); // pathの最後の部分を画像のIDとして使う（例: "image1.jpg"）
                    const exists = await isImageInDB(imageId);
                
                    if (!exists) {
                        console.log(`Saving image ${imageId} to IndexedDB...`);
                        saveImageToDB(path, imageId);
                    } else {
                        console.log(`Image ${imageId} already exists in IndexedDB.`);
                    }
                }

                loadImageToAImage("YahataShrine(iwakai)3_360.jpg", "image360");
                loadImageToAImage("YahataShrine(iwakai)2_rf.jpg", "linkSphere2");
            };

            // 画像を見つめたときにページ移動するイベント
            document.querySelector('#linkSphere').addEventListener('click', function () {
                window.location.href = "../index.html";
            });

            document.querySelector('#linkSphere2').addEventListener('click', function () {
                window.location.href = "./yahataShrineIwakai2.html";
            });
        </script>
    </a-scene>
</body>
</html>